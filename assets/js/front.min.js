!function(t){var e=jQuery("body"),s=jQuery(window),i=jQuery(document),a=jQuery("html");function n(t,e,s){e=e.toLowerCase(),s=parseInt(s);var i=t;!t instanceof Date&&(i=new Date(t));var a=function(){i.getDate()!=t.getDate()&&i.setDate(0)};switch(e){case"year":i.setFullYear(i.getFullYear()+s),a();break;case"quarter":i.setMonth(i.getMonth()+3*s),a();break;case"month":i.setMonth(i.getMonth()+s),a();break;case"week":i.setDate(i.getDate()+7*s);break;case"day":i.setDate(i.getDate()+s);break;case"hour":i.setTime(i.getTime()+36e5*s);break;case"minute":i.setTime(i.getTime()+6e4*s);break;case"second":i.setTime(i.getTime()+1e3*s);break;default:i=void 0}return i}function o(t){this.allowLog=!1,this.settings=t,this.id=t.campaign_id,this.type=t.campaign_type,this.ui={},this.slugs={},this.init()}o.prototype.init=function(){if(this.log("# Init"),this.createSlugs(),this.checkIfSettingsChanged(),!this.isSubscribePaused()&&!this.isSessionPaused()){if(this.render(),this.setupBar(),this.setupUrgency(),this.onCloseClick(),this.ajaxSubscribeListener(),"widget-form"===this.type||"content-form"===this.type)this.showCampaign();else{var t=["load","exit","scroll"],e="random"!==this.settings.display_trigger?this.settings.display_trigger:t[Math.floor(Math.random()*t.length)];"exit"===e?this.onMouseLeave():"load"===e?this.onPageLoad():"scroll"===e&&this.onPageScroll()}return this}},o.prototype.createSlugs=function(){this.slugs.campaign="SKYT["+SKYT_PARAMS.site_id+"]["+this.id+"]_",this.slugs.last_change=this.slugs.campaign+"last_change",this.slugs.pause_date=this.slugs.campaign+"pause_date",this.slugs.session_date=this.slugs.campaign+"session_date",this.slugs.session_pause_date=this.slugs.campaign+"session_pause_date",this.slugs.sub_pause_date=this.slugs.campaign+"sub_pause_date",this.slugs.has_subscribed="SKYT["+SKYT_PARAMS.site_id+"]_has_subscribed"},o.prototype.checkIfSettingsChanged=function(){return this.getStorage(this.slugs.last_change)==this.settings.last_settings_update?(this.log("Settings have not changed"),!1):(this.setStorage(this.slugs.last_change,this.settings.last_settings_update),this.deleteStorage(this.slugs.pause_date),this.deleteStorage(this.slugs.session_date),this.deleteStorage(this.slugs.session_pause_date),this.deleteStorage(this.slugs.sub_pause_date),this.log("Settings have changed"),!0)},o.prototype.render=function(){"widget-form"===this.type||"content-form"===this.type?e.find('.skytake-placeholders[data-id="'+this.id+'"]').replaceWith(this.settings.campaign_markup):e.append(this.settings.campaign_markup),this.ui.campaign=e.find("#skytake-"+this.id),this.ui.urgency=this.ui.campaign.find(".skytake-urgency"),this.ui.container=this.ui.campaign.find(".skytake-container"),"popup"===this.type&&(this.ui.overlay=e.find('.skytake-overlay[data-target="'+this.id+'"]')),this.settings.hasOwnProperty("minimized_bar_markup")&&(e.append(this.settings.minimized_bar_markup),this.ui.bar=e.find('.skytake-bar[data-target="'+this.id+'"]'))},o.prototype.setupBar=function(){if(this.log("# Minimized bar setup called"),this.log("Has minimized bar? "+(this.ui.hasOwnProperty("bar")?"YES":"NO")),this.log("Minimized bar display: "+this.settings.display_minimized_bar),this.ui.hasOwnProperty("bar")&&"never"!==this.settings.display_minimized_bar){"always"===this.settings.display_minimized_bar&&this.showBar();var t=this;t.ui.bar.on("click",function(e){e.preventDefault(),t.deleteStorage(t.slugs.pause_date),t.showCampaign()})}},o.prototype.showBar=function(){if(this.log("# Hide bar called"),!this.isSubscribePaused()&&this.ui.hasOwnProperty("bar"))return this.ui.bar.addClass("__show"),this},o.prototype.hideBar=function(){if(this.log("# Hide bar called"),this.ui.hasOwnProperty("bar"))return this.ui.bar.removeClass("__show"),this},o.prototype.setupUrgency=function(){if(this.log("# Urgency setup called"),this.log("Urgency type: "+this.settings.urgency_type),"disabled"===this.settings.urgency_type)return!1;var t,e=this;if(e.showUrgency(),"usage_limit"===e.settings.urgency_type)return e;if("expiry_date"===e.settings.urgency_type?t=new Date(parseInt(this.settings.urgency_date_timestamp)):"session"===e.settings.urgency_type&&((!e.getSessionDate()||new Date>e.getSessionPauseDate())&&(e.setSessionDate(),e.setSessionPauseDate()),t=e.getSessionDate()),isNaN(t.getTime()))return e;var s=e.ui.urgency.find(".skytake-urgency-timer");return e.ui.urgency.countdown(t,function(t){s.find(".__days span:first").text(t.strftime("%D")),s.find(".__hours span:first").text(t.strftime("%H")),s.find(".__minutes span:first").text(t.strftime("%M")),s.find(".__seconds span:first").text(t.strftime("%S"))}).on("finish.countdown",function(){e.hasSubscribed()||(e.hideCampaign(),e.hideBar())}),e},o.prototype.showUrgency=function(){this.ui.urgency.removeClass("__hidden")},o.prototype.hideUrgency=function(){this.ui.urgency.addClass("__hidden")},o.prototype.onCloseClick=function(){var t=this;t.ui.campaign.find(".skytake-close").on("click",function(e){e.preventDefault(),t.hideCampaign()})},o.prototype.onMouseLeave=function(){var t=this,e="mouseleave.skytake_"+this.id;i.on(e,function(e){t.log("Mouse left the window"),t.showCampaign()})},o.prototype.onPageLoad=function(){var t=this;setTimeout(function(){t.showCampaign()},1e3*parseInt(t.settings.display_trigger_after))},o.prototype.onPageScroll=function(){var t,e=this;return i.height()===s.height()?(e.showCampaign(),this):(s.on("scroll",function(){clearTimeout(t),t=setTimeout(function(){s.scrollTop()/(i.height()-s.height())*100>parseFloat(e.settings.popup_scroll_percentage)&&e.showCampaign()},20)}).scroll(),this)},o.prototype.showCampaign=function(){if(this.log("# Show campaign called"),!this.isSubscribePaused()&&!this.isSessionPaused()){if("popup"===this.type||"floating-bar"===this.type||"scroll-box"===this.type){if(this.isPaused())return;this.setPauseDate()}return"popup"===this.type&&this.ui.overlay.addClass("__show"),this.ui.campaign.addClass("__show"),"popup"===this.type&&(this.ui.campaign.height()>=s.height()&&this.ui.campaign.addClass("__top_zero"),a.addClass("__skytake_opened")),this.hideBar(),this.updateViewsStat(),this}},o.prototype.hideCampaign=function(){return this.log("# Hide campaign called"),this.ui.campaign.removeClass("__show"),"popup"===this.type&&(this.ui.overlay.removeClass("__show"),a.removeClass("__skytake_opened")),"never"!==this.settings.display_minimized_bar&&this.showBar(),this},o.prototype.showSuccess=function(){return this.ui.campaign.addClass("__show_response"),this},o.prototype.hideSuccess=function(){return this.ui.campaign.removeClass("__show_response"),this},o.prototype.isPaused=function(t){t=t||new Date;var e=this.getPauseDate();return e&&t<e?(this.log("Is close paused? YES"),!0):(this.log("Is close paused? NO"),!1)},o.prototype.getPauseDate=function(){var t=this.getStorage(this.slugs.pause_date);return!!t&&new Date(t)},o.prototype.setPauseDate=function(){var t=this.settings.reminder_type_notsub.toLowerCase(),e=parseInt(this.settings.reminder_number_notsub),s=n(new Date,t,e);return this.setStorage(this.slugs.pause_date,s),s},o.prototype.ajaxSubscribeListener=function(){var e=this,s=e.ui.campaign.find(".skytake-form");s.on("submit",function(i){i.preventDefault(),e.log("Form submit called"),s.addClass("__loading");var a=s.find(".skytake-gdpr");if(a.length&&!a.is(":checked"))return!1;t.ajax({type:"POST",url:e.settings.ajaxurl,data:{action:"skytake_subscribe",nonce:e.settings.nonce,campaign_id:e.settings.campaign_id,email:s.find(".skytake-email").val(),name:s.find(".skytake-name").val(),mobile:s.find(".skytake-mobile").val()}}).done(function(t){t.success?e.subscribe():alert(t.data),s.removeClass("__loading")})})},o.prototype.subscribe=function(){return this.setStorage(this.slugs.has_subscribed,!0),this.setSubscribePauseDate(),this.showSuccess(),this.hideBar(),Object.keys(skytake).map(function(t){t!=this.id&&(skytake[t].hideCampaign(),skytake[t].hideBar(),skytake[t].setSubscribePauseDate())}.bind(this)),this},o.prototype.updateViewsStat=function(){t.ajax({type:"POST",url:this.settings.ajaxurl,data:{action:"skytake_update_campaign_views",nonce:this.settings.nonce,campaign_id:this.id}})},o.prototype.hasSubscribed=function(){return this.getStorage(this.slugs.has_subscribed)?(this.log("Current user has subscribed"),!0):(this.log("Current user has not subscribed"),!1)},o.prototype.isSubscribePaused=function(t){if(!this.hasSubscribed())return!1;t=t||new Date;var e=this.getSubscribePauseDate();return e&&t<e?(this.log("Is subscribe paused? YES"),!0):(this.log("Is subscribe paused? NO"),!1)},o.prototype.setSubscribePauseDate=function(){var t=n(new Date,"day",parseInt(this.settings.reminder_number_sub));return this.setStorage(this.slugs.sub_pause_date,t),t},o.prototype.getSubscribePauseDate=function(){var t=this.getStorage(this.slugs.sub_pause_date);return!!t&&new Date(t)},o.prototype.isSessionPaused=function(t){if("session"!==this.settings.urgency_type)return!1;t=t||new Date;var e=this.getSessionDate(),s=this.getSessionPauseDate();return e&&s&&t>e&&t<s?(this.log("Is urgency session paused? YES"),!0):(this.log("Is urgency session paused? NO"),!1)},o.prototype.setSessionDate=function(){var t=n(new Date,this.settings.urgency_session_type,parseInt(this.settings.urgency_session_time));return this.setStorage(this.slugs.session_date,t),t},o.prototype.getSessionDate=function(){var t=this.getStorage(this.slugs.session_date);return!!t&&new Date(t)},o.prototype.setSessionPauseDate=function(){var t=this.getSessionDate();t&&"Invalid Date"!==t||(t=this.setSessionDate());var e=n(t,"day",this.settings.urgency_session_pause_time);return this.setStorage(this.slugs.session_pause_date,e),e},o.prototype.getSessionPauseDate=function(){var t=this.getStorage(this.slugs.session_pause_date);return!!t&&new Date(t)},o.prototype.getStorage=function(t){return localStorage.getItem(t)},o.prototype.setStorage=function(t,e){localStorage.setItem(t,e)},o.prototype.deleteStorage=function(t,e){localStorage.removeItem(t)},o.prototype.log=function(t){this.allowLog&&"object"==typeof console&&console.log("[SKYT]["+this.id+"]["+this.type+"] "+t)},window.skytake={};var r=[];t(".skytake-placeholders").each(function(e){r.push(t(this).data("id"))}),window.hasOwnProperty("SKYT_PARAMS")&&t.ajax({type:"POST",url:SKYT_PARAMS.ajaxurl,data:{action:"skytake_get_popup",nonce:SKYT_PARAMS.nonce,ids:SKYT_PARAMS.ids,non_floating_ids:r}}).done(function(t){t.success&&t.data.map(function(t){skytake[t.campaign_id]=new o(t)})})}(jQuery);